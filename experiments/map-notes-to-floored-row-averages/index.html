<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<title>Musical Cells</title>
	<script src="js/cellular-automata-1d.js"></script>
	<script src="js/d3/d3.min.js"></script>
	<script src="js/BandJS/band.min.js"></script>
	<link rel="stylesheet" href="css/style.css">

<style>
	
	
</style>
</head>
<body>

	<div class="header">
		<p class="main-title">Musical Cells</p>
		<p class="main-subtitle">Experiment #3 - Mapping Notes to Floored Row Averages</p>
		<p class="authors">by Brett Moran</p>
	</div>
	<div class="container">
		<div class="section">
			<!-- <h2>
				Introduction
			</h2> -->
			<p class="section-intro">
				Have you ever wondered what a fractal might sound like?
			</p>
		</div>

		
		<div id="vis8" class="interactive">
			<div class="wrapper">
				<div id="sandbox-controls">
					<button id="random-rule-button" class="sc-button">Random Rule</button>
					<button id="check-box-button-random-seeds" class="random-seeds-checked">Randomize Seeds</button>
					<button id="refresh-button" class="sc-button">Play</button>
					<button id="stop-button" class="sc-button">Stop</button>
					<label id="rule-label">Rule: </label>
					<!-- <div id="select-box8">
						<label>Choose Rule</label>
						<select name="rules" id="select-rule"></select>
					</div> -->
				</div>
				<svg></svg>
				<!-- <iframe src="" frameborder="0"></iframe> -->
			</div>
		</div>

		<div class="footer">
			
		</div>

	</div>

	<script>

			
			var stateColors = [ "#a6a6a6", "#28a328", "#ff0099" ];
			var fillColors = [ "#dedede", "#48c448", "#dd0099" ];
			

			var images = [ "img/asleep-cell-square.svg", "img/awake-cell-square.svg" ];
			var ghostImages = [ "img/asleep-cell-square-ghost.svg", "img/awake-cell-square-ghost.svg" ];

			
			var i = 0;

			var mainrule = 146;


			// //create the context for the web audio
			// var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
			// //create, tune, start and connect each oscillator sinea, sineb and sinec
			// var sinea = audioCtx.createOscillator();
			// sinea.frequency.value = 440;
			// sinea.type = "sine";
			// sinea.start();
			// sinea.connect(audioCtx.destination);
			// var sineb = audioCtx.createOscillator();
			// sineb.frequency.value = 523.25;
			// sineb.type = "sine";
			// sineb.start();
			// sineb.connect(audioCtx.destination);
			// var sinec = audioCtx.createOscillator();
			// sinec.frequency.value = 698.46;
			// sinec.type = "sine";
			// sinec.start();
			// sinec.connect(audioCtx.destination);

			var numRuns = 120;

			// var notes = ["rest", "C2", "C#2", "D2", "Eb2", "E2", "F2", "F#2", "G2", "G#2", "A2", "Bb2", "B2",
			// 						 "C3", "C#3", "D3", "Eb3", "E3", "F3", "F#3", "G3", "G#3", "A3", "Bb3", "B3",
			// 						 "C4", "C#4", "D4", "Eb4", "E4", "F4", "F#4", "G4", "G#4", "A4", "Bb4", "B4",
			// 						 "C5", "C#5", "D5", "Eb5", "E5", "F5", "F#5", "G5", "G#5", "A5", "Bb5", "B5",
			// 						 "C6", "C#6", "D6", "Eb6", "E6", "F6", "F#6", "G6", "G#6", "A6", "Bb6", "B6",
			// 						 "C7", "C#7", "D7", "Eb7", "E7", "F7", "F#7", "G7", "G#7", "A7", "Bb7", "B7"];

			var notes = ["rest", "C3", "C#3", "D3", "Eb3", "E3", "F3", "F#3", "G3", "G#3", "A3", "Bb3", "B3",
									 "C4", "C#4", "D4", "Eb4", "E4", "F4", "F#4", "G4", "G#4", "A4", "Bb4", "B4",
									 "C5", "C#5", "D5", "Eb5", "E5", "F5", "F#5", "G5", "G#5", "A5", "Bb5", "B5"];	


			// var notes = ["rest", "C4", "C#4", "D4", "Eb4", "E4", "F4", "F#4", "G4", "G#4", "A4", "Bb4", "B4"];

			var ca = CA(1,2).numCells(200).rule(110).run(numRuns);

			var gens = ca.cellStates();
			var tempo = 90;
			var conductor = new BandJS();
			conductor.setTimeSignature(4,4);
			conductor.setTempo(tempo);
			var piano = conductor.createInstrument();
			var player;

			// var allMeasures = [];
			// for (var i=0; i<gens.length; i++) {
			// 	var notelist = [];
			// 	var g = gens[i];
			// 	for (var j=0; j<g.length; j++) {
			// 		var k = +g[j];
			// 		if (k === 1) notelist.push(notes[j%notes.length]);
			// 	}
			// 	notelist = notelist.join();
			// 	console.log(notelist);
			// 	allMeasures.push(notelist);
			// 	// piano.note("quarter", )
			// }

			// for (var i=0; i<allMeasures.length; i++) {
			// 	piano.note("quarter", allMeasures[i]);
			// }
			// // piano.note("quarter", "C4");
			// // piano.note("quarter", "C4");
			// // piano.note("quarter", "C4");
			// // piano.note("quarter", "C4,F4");
	 	//   // piano.note('tripletHalf','D4,F4,G2,A5')
   // //    piano.note('tripletEighth','D4')
   // //    piano.note('tripletEighth','C4')
   // //    piano.note('tripletEighth','D4', true)
   // //    piano.note('tripletSixteenth','D4')
   // //    piano.note('tripletEighth','D4,Bb4')
   // //    piano.rest('tripletSixteenth')
   // //    piano.note('sixteenth','D4,Bb4')
   // //    piano.note('sixteenth','Eb4,C5')
   // //    piano.note('sixteenth','F4,D5')
   // //    piano.note('sixteenth','G4,Eb5');
			// var player = conductor.finish();
			// // player.play();


			setupSandbox(d3.select("#vis8"));
			

			function setupSandbox(div) {

				var ghostImages = [ "img/asleep-cell-square-ghost.svg", "img/awake-cell-square-ghost.svg" ];
				var randomInit = false;

				var width = 960;
				var height =  numRuns * width / ca.numCells();
				// var maxSteps = 20;

				var svg = div.select("svg")
						.attr("width", width)
						.attr("height", height)
						// .style("border", "1px solid #ddd");

				// var ca = CA(1,2)
				// 		.numCells(135)
				// 		.rule(mainrule)
						// .randomizeStates();



				// var ruleOptions = div.select("#select-rule").selectAll(".option-rules").data(d3.range(ca.ruleRange()[1]+1))
				// 	.enter().append("option")
				// 		.property("value", function(d,i){ return d; })
				// 		.property("selected", function(d,i){ return d === ca.rule() ? "selected" : ""; })
				// 		.text(function(d,i){ return d; });
				// div.select("#select-rule")
				// 	.on("change", function(d,i){
				// 		var val = d3.select('select').property('value');
				// 		console.log(val);
				// 		ca.reset();
				// 		ca.rule(val);
				// 		arrRule = ca.ruleComponents();

				// 		ruleCells.data(ca.ruleComponents()).classed("sleeping", function(a,b){ return a === 0 ? true : false; }).attr("xlink:href", function(a,b){ return images[a]; });
				// 		ruleOptions.property("selected", function(d,i){ return d === ca.rule() ? "selected" : ""; })
				// 		// ruletext.text("Rule: " + ca.rule());

				// 		if (randomInit) ca.randomizeStates();
				// 		ca.run(numRuns);

				// 		rowgroups.data(ca.cellStatesStr()).each(function(d,i){
				// 			d3.select(this).selectAll(".row-cells").data(d)
				// 					// .attr("xlink:href", function(a,b){ return ghostImages[a]; });
				// 					.attr("fill", function(a,b){ return fillColors[a]; })
				// 					.attr("stroke", function(a,b){ return stateColors[a]; })
				// 		});
				// 	})

				// var size = Math.floor(0.85 * width / ca.numCells());
				var size = 20;
				// var runs = Math.floor(height / size);

				// ca.run(runs-1);

				var xscale = d3.scale.ordinal()
						.domain(d3.range(ca.numCells()))
						.rangeRoundBands([0* width, 1*width], 0, 0);

				var yscale = d3.scale.ordinal()
						.domain(d3.range(numRuns+1))
						.rangeRoundBands([0, height], 0, 0);

				var cellstatedata = ca.cellStatesStr();

				var rowgroups = svg.selectAll(".row-groups").data(cellstatedata)
					.enter().append("g");

				rowgroups.each(function(d,i){
					var me = d3.select(this);

					me.selectAll(".row-cells").data(d)
						.enter().append("rect")
						// .enter().append("svg:image")
							.attr("class", "row-cells")
							.attr("x", function(a,b){ return xscale(b); })
							.attr("y", function(a,b){ return yscale(i); })
							.attr("rx", 0.5)
							.attr("width", width / ca.numCells())
							.attr("height", width / ca.numCells())
							// .attr("xlink:href", function(a,b){ return ghostImages[a]; })
							.attr("fill", function(a,b){ return fillColors[a]; })
							.attr("stroke", function(a,b){ return stateColors[a]; })
							.attr("stroke-width", 0.3)
							.style("opacity", 1);
				})

				
				var randomRuleButton = div.select("#random-rule-button").on("click", function(){
					ca.reset();
					ca.randomRule();
					arrRule = ca.ruleComponents();

					// ruleCells.data(ca.ruleComponents()).classed("sleeping", function(a,b){ return a === 0 ? true : false; }).attr("xlink:href", function(a,b){ return images[a]; });
					// ruleOptions.property("selected", function(d,i){ return d === ca.rule() ? "selected" : ""; })
					// ruletext.text("Rule: " + ca.rule());

					if (randomInit) ca.randomizeStates();
					ca.run(numRuns);

					ruleLabel.text("Random Rule (" + ca.rule() + ")");

					rowgroups.data(ca.cellStatesStr()).each(function(d,i){
						d3.select(this).selectAll(".row-cells").data(d)
								// .attr("xlink:href", function(a,b){ return ghostImages[a]; });
								.attr("fill", function(a,b){ return fillColors[a]; })
								.attr("stroke", function(a,b){ return stateColors[a]; })
					});

				});

				var ruleLabel = d3.select("#rule-label");
				ruleLabel.text("Random Rule (" + ca.rule() + ")");

				var refreshButton = div.select("#refresh-button").text("Play sound").on("click", function(){
					// ca.reset();
					
					// if (randomInit) ca.randomizeStates();
					// ca.run(runs-1);

					// rowgroups.data(ca.cellStatesStr()).each(function(d,i){
					// 	d3.select(this).selectAll(".row-cells").data(d)
					// 			// .attr("xlink:href", function(a,b){ return ghostImages[a]; });
					// 			.attr("fill", function(a,b){ return fillColors[a]; })
					// 			.attr("stroke", function(a,b){ return stateColors[a]; })
					// });
					if (player !== undefined) player.stop();
					var conductor = new BandJS();
					conductor.setTimeSignature(4,4);
					conductor.setTempo(tempo);
					var piano = conductor.createInstrument();

					gens = ca.cellStates();

					var rowTotals = [];

					var allMeasures = [];

					var rowVals = vecOp(gens, function(d,i){ return Math.floor(sum(d) * (notes.length-1) / ca.numCells()); });
					var allMeasures = vecOp(rowVals, function(d,i){ return notes[d]; });

					for (var i=0; i<allMeasures.length; i++) {
						if (allMeasures[i] === "rest") piano.rest("quarter");
						else piano.note("eighth", allMeasures[i]);
					}
					player = conductor.finish();

					console.log(rowTotals.join());
					// console.log(vecOp(rowTotals, function(d){ return d / ca.numCells(); }))
					player.play();
				});

				var stopButton = div.select("#stop-button").text("Stop").on("click", function() {
					player.stop();
				})

				var randomStart = div.select("#check-box-button-random-seeds");
				randomStart.classed("random-seeds-checked", false);
				randomStart.on("click", function(){
					d3.select(this).classed("random-seeds-checked", !d3.select(this).classed("random-seeds-checked"));
					randomInit = !randomInit;

					ca.reset();
					arrRule = ca.ruleComponents();

					// ruleCells.data(ca.ruleComponents()).classed("sleeping", function(a,b){ return a === 0 ? true : false; }).attr("xlink:href", function(a,b){ return images[a]; });
					// ruleOptions.property("selected", function(d,i){ return d === ca.rule() ? "selected" : ""; })
					// ruletext.text("Rule: " + ca.rule());

					if (randomInit) ca.randomizeStates();
					ca.run(numRuns);

					rowgroups.data(ca.cellStatesStr()).each(function(d,i){
						d3.select(this).selectAll(".row-cells").data(d)
								// .attr("xlink:href", function(a,b){ return ghostImages[a]; });
								.attr("fill", function(a,b){ return fillColors[a]; })
								.attr("stroke", function(a,b){ return stateColors[a]; })
					});


				})
			}

			function setupChangingOfTheStates(div) {
				var width = 960;
				var height = 600;
				var maxSteps = 20;

				var svg = div.select("svg")
						.attr("width", width)
						.attr("height", height)
						// .style("border", "1px solid #ddd");

				var size = 35;

				var ca = CA(1,2)
						.numCells(21)
						.rule(mainrule)
						.randomizeStates();

				var button = div.select("#randomize-states").on("click", function(){
					ca.reset();
					ca.randomizeStates();

					cells
						.data(ca.currentCellStates())
						.each(function(d,i){
							d3.select(this).select("image").attr("xlink:href", images[d]);
						});

					nextcells.style("opacity", 0);
					cells.selectAll("rect").style("opacity", 0);
					socsits.selectAll("rect").style("opacity", 0);

					nextcells
						.data(ca.run().currentCellStates())
							.attr("xlink:href", function(d,i){ return images[d]; });
				});

				var xscale = d3.scale.ordinal()
						.domain(d3.range(ca.numCells()))
						.rangeRoundBands([0* width, 0.80*width], 0, 0);

				var cells = svg.append("g").selectAll(".cots-cells").data(ca.currentCellStates())
						.enter().append("g").each(function(d,i){
							
							d3.select(this).append("svg:image")
									.attr("class", "cots-cells cots-cell"+i)
									.attr("x", xscale(i))
									.attr("y", height/2 - size/2 - size/2)
									.attr("width", size)
									.attr("height", size)
									.attr("xlink:href", images[d])
									.style("opacity", 1);

							d3.select(this).append("rect")
									.attr("class", "hat")
									.attr("x", xscale(i) + (size*0.25))
									.attr("y", height/2 - size/2 - size/2 - size/1.5)
									.attr("rx", 0)
									.attr("width", size/2)
									.attr("height", size/1.5)
									.attr("stroke", "#333")
									.attr("stroke-width", 2.5)
									.style("opacity", 0);

							d3.select(this).append("rect")
								.attr("x", xscale(i))
								.attr("y", height/2 - size/2 - size/2)
								.attr("width", size)
								.attr("height", 3)
								.attr("fill", "#333")
								.style("opacity", 0);

						})
						.on("mouseover", function(d,i){
							// reset next cells and hats
							nextcells.style("opacity", 0);
							cells.selectAll("rect").style("opacity", 0);
							socsits.selectAll("rect").style("opacity", 0);

							nextcells.filter(function(a,b){ return i === b; }).style("opacity", 1);
							var left = cells.filter(function(a,b){ return b === mod(i-1, ca.numCells()); });
							var right = cells.filter(function(a,b){ return b === mod(i+1, ca.numCells()); });
							var me = d3.select(this);

							left.selectAll("rect").style("opacity", 1);
							left.select(".hat").attr("fill", "#333");

							me.selectAll("rect").style("opacity", 1);
							me.select(".hat").attr("fill", "#999");

							right.selectAll("rect").style("opacity", 1);
							right.select(".hat").attr("fill", "#ddd");

							var neighborhood = [left.datum(), d, right.datum()];

							var soc = socsits.filter(function(a,b){ return areArraysEqual(a, neighborhood); });
							soc.selectAll("rect").style("opacity", 1);
						})
						// .on("mouseout", function(d,i){
						// 	nextcells.filter(function(a,b){ return i === b; }).style("opacity", 0);
						// 	var left = cells.filter(function(a,b){ return b === mod(i-1, ca.numCells()); });
						// 	var right = cells.filter(function(a,b){ return b === mod(i+1, ca.numCells()); });
						// 	var me = d3.select(this);

						// 	left.selectAll("rect").style("opacity", 0);
						// 	me.selectAll("rect").style("opacity", 0);
						// 	right.selectAll("rect").style("opacity", 0);

						// 	socsits.selectAll("rect").style("opacity", 0);
						// })
							

				var nextcells = svg.append("g").selectAll(".cots-next-cells").data(ca.run().currentCellStates())
						.enter().append("svg:image")
							.attr("class", function(d,i){ return "cots-next-cells cots-next-cell"+i; })
							.attr("x", function(d,i){ return xscale(i); })
							.attr("y", height/2 + size/2 - size/2)
							.attr("width", size)
							.attr("height", size)
							.attr("xlink:href", function(d,i){ return images[d]; })
							.style("opacity", 0);


				var vline = svg.append("line")
						.attr("x1", 0.835*width)
						.attr("y1", 0.05*height)
						.attr("x2", 0.835*width)
						.attr("y2", 0.95*height)
						.attr("stroke", "#ddd")



				var configs = [ [1,1,1],
												[1,1,0],
												[1,0,1],
												[1,0,0],
												[0,1,1],
												[0,1,0],
												[0,0,1],
												[0,0,0] ];

				var arrRule = ca.rule(mainrule).ruleComponents();

				var rulesize = 18;
				// var arrRule = padZeros(dec2basek(decRule, 2), 1);

				var socsits = svg.selectAll(".cots-ss-cell-groups").data(configs)
					.enter().append("g")
						.attr("class", "cots-ss-cell-groups");

				// var ys = [rulesize*2, 3*rulesize*2, 5*rulesize*2, 7*rulesize*2];
				socsits.each(function(d,i){
					var me = d3.select(this);

					me.append("g").selectAll(".cots-ss-cell").data(d)
						.enter().append("g")
						.each(function(a,b){
							d3.select(this).append("svg:image")
									.attr("x", 0.875 * width + (b * rulesize))
									.attr("y", 80 + rulesize * i * 3.5)
									.attr('width', rulesize)
									.attr('height', rulesize)
									.attr("xlink:href", images[a]);

							d3.select(this).append("rect")
									.attr("x", 0.875 * width + (b * rulesize) + (rulesize * 0.25))
									.attr("y", 80 + rulesize * i * 3.5 - rulesize/1.5)
									.attr("rx", 0)
									.attr("width", rulesize/2)
									.attr("height", rulesize/1.5)
									.attr("fill", b === 0 ? "#333" : b === 1 ? "#999" : "#ddd")
									.attr("stroke", "#333")
									.attr("stroke-width", 1.5)
									.style("opacity", 0);

							d3.select(this).append("rect")
								.attr("x", 0.875 * width + (b * rulesize))
								.attr("y", 80 + rulesize * i * 3.5 - 1)
								.attr("width", rulesize)
								.attr("height", 2)
								.attr("fill", "#333")
								.style("opacity", 0);
						})
					
					
				})

				var ruleCells = svg.selectAll(".s-plus-1-cell").data(arrRule)
					.enter().append("svg:image")
						.attr("x", function(a,b){ return 0.875 * width + rulesize; })
						.attr("y", function(a,b){ return 80 + (rulesize * b * 3.5)+rulesize; })
				    .attr('width', rulesize)
				    .attr('height', rulesize)
				    .attr("xlink:href", function(a,b){ return images[a]; })
				    .classed("sleeping", function(a,b){ return a === 0 ? true : false; })
				    .style("cursor", "pointer")
				   .on("click", function(d,i){
				   		var me = d3.select(this);
				   		me.classed("sleeping", !me.classed("sleeping"));

				   		ruleCells.each(function(a,b){
					  		var sleeping = d3.select(this).classed("sleeping");
				  			arrRule[b] = sleeping ? 0 : 1;
				   		});

				   		var csstr = ca.cellStatesStr()[0];
				   		ca.reset();
				   		ca.rule(basek2dec(arrRule, 2)).customStates(csstr);

				   		nextcells.data(ca.run().currentCellStates()).attr("xlink:href", function(a,b){ return images[a]; });
				   		ruleCells.data(ca.ruleComponents()).attr("xlink:href", function(a,b){ return images[a]; });

				   		ruletext.text("Rule: " + ca.rule());


				   })

				var ruletext = svg.append("text")
						.attr("x", 0.875 * width + rulesize + rulesize /2)
						.attr("y", 50)
						.text("Rule: " + ca.rule())
						.attr("text-anchor", "middle")
			}

			function setupExploreNetwork(div) {

				var svg = div.select("svg");

				var width = 960;
				var height = 400;
				svg.attr("width", width).attr("height", height);

				var ca = CA(1,2)
						.numCells(11)
						.rule(mainrule)
						.randomizeStates();
						// .run();

				var center = { x: 3 * width / 4, y: height / 2 };
				var radius = 170;
				var size = 30;
				var angle = 2 * Math.PI / ca.numCells();
				var angleoffset = Math.PI/2;

				var cellLocs = [];
				for (var i=0; i<ca.numCells(); i++) {
					cellLocs[i] = { x: radius * Math.cos(i * angle + angleoffset) + center.x - size/2,
													y: radius * Math.sin(i * angle + angleoffset) + center.y - size/2 };
				}

				for (var i=0; i<ca.numCells(); i++) {
					var x1, x2, y1, y2;

					x1 = cellLocs[i].x + size/2;
					y1 = cellLocs[i].y + size/2;
					x2 = cellLocs[mod(i+1, cellLocs.length)].x + size/2;
					y2 = cellLocs[mod(i+1, cellLocs.length)].y + size/2;

					svg.append("line")
							.attr("class", "sn-line")
							.attr("x1", x1)
							.attr("y1", y1)
							.attr("x2", x2)
							.attr("y2", y2)
							.attr("stroke", "#eee")
							.attr("stroke-width", 3);
				}

				var currentcells = svg.selectAll(".chosen-cells").data([-1,0,1])
					.enter().append("g")
						.attr("class", "chosen-cells");

				var cellGroup = svg.append("g").selectAll(".ecn-cells").data(ca.currentCellStates())
						.enter().append("g");
				cellGroup.each(function(d,i){
					var me = d3.select(this);
					// var numCells = ca.numCells();
					var loc = cellLocs[i];
					
					var c = me.append("svg:image")
							.attr("class", "cn-cells cn-cell"+i)
							.attr("x", loc.x)
							.attr("y", loc.y)
							.attr("width", size)
							.attr("height", size)
							.attr("xlink:href", images[d])
						.on("mouseover", function(){
							// happy face; chatting face
							// text bubble, saying hi to neighbors
							
							var lines = d3.selectAll(".sn-line");
							lines.attr("stroke", "#eee");
							lines.filter(function(a,b){ return (b === i) || (b === mod(i-1, cellLocs.length)); })
									.attr("stroke", "#ccc");

							currentcells.each(function(a,b){
								var loc = cellLocs[mod(i+a, cellLocs.length)];
								var me = d3.select(this);
								me.selectAll("rect").remove();

									me.append("rect")
										.attr("x", loc.x + size/4)
										.attr("y", loc.y - size/1.5 + 1)
										.attr("rx", 0)
										.attr("width", size/2)
										.attr("height", size/1.5)
										.attr("fill", b === 0 ? "#333" : b === 1 ? "#999" : "#ddd")
										.attr("stroke", "#333")
										.attr("stroke-width", 2.5);

									me.append("rect")
										.attr("x", loc.x)
										.attr("y", loc.y - 2)
										.attr("width", size)
										.attr("height", 3)
										.attr("fill", "#333")

								loc = rowcellLocs[mod(i+a, cellLocs.length)];
									me.append("rect")
										.attr("x", loc.x + size/4)
										.attr("y", loc.y - size/1.5 + 1)
										.attr("rx", 0)
										.attr("width", size/2)
										.attr("height", size/1.5)
										.attr("fill", b === 0 ? "#333" : b === 1 ? "#999" : "#ddd")
										.attr("stroke", "#333")
										.attr("stroke-width", 2.5)

									me.append("rect")
										.attr("x", loc.x)
										.attr("y", loc.y - 2)
										.attr("width", size)
										.attr("height", 3)
										.attr("fill", "#333")
							});

						});
				});
					

				svg.append("line")
						.attr("x1", width * 0.5)
						.attr("y1", height * 0.1)
						.attr("x2", width * 0.5)
						.attr("y2", height * 0.9)
						.attr("stroke", "#aaa");

				var xscale = d3.scale.ordinal()
						.domain(d3.range(ca.numCells()))
						.rangeRoundBands([0.05 * width, 0.45 * width], 0, 0);

				var rowcellLocs = [];
				var rowcellsize = 30;
				for (var i=0; i<ca.numCells(); i++) {
					rowcellLocs[i] = { x: xscale(i), y: height/2 };
				}

				var cells = svg.append("g").selectAll(".ecn-row-cells").data(ca.currentCellStates())
						.enter().append("svg:image")
							.attr("class", function(d,i){ return "ecn-row-cells ecn-row-cell"+i; })
							.attr("x", function(d,i){ return rowcellLocs[i].x; })
							.attr("y", function(d,i){ return rowcellLocs[i].y; })
							.attr("width", rowcellsize)
							.attr("height", rowcellsize)
							.attr("xlink:href", function(d,i){ return images[d]; })
						.on("mouseover", function(d,i){
							var lines = d3.selectAll(".sn-line");
							lines.attr("stroke", "#eee");
							lines.filter(function(a,b){ return (b === i) || (b === mod(i-1, cellLocs.length)); })
									.attr("stroke", "#aaa");

							currentcells.each(function(a,b){
								var loc = cellLocs[mod(i+a, cellLocs.length)];
								var me = d3.select(this);
								me.selectAll("rect").remove();

									me.append("rect")
										.attr("x", loc.x + size/4)
										.attr("y", loc.y - size/1.5 + 1)
										.attr("rx", 0)
										.attr("width", size/2)
										.attr("height", size/1.5)
										.attr("fill", b === 0 ? "#333" : b === 1 ? "#999" : "#ddd")
										.attr("stroke", "#333")
										.attr("stroke-width", 2.5);

									me.append("rect")
										.attr("x", loc.x)
										.attr("y", loc.y - 2)
										.attr("width", size)
										.attr("height", 3)
										.attr("fill", "#333")

								loc = rowcellLocs[mod(i+a, cellLocs.length)];
									me.append("rect")
										.attr("x", loc.x + size/4)
										.attr("y", loc.y - size/1.5 + 1)
										.attr("rx", 0)
										.attr("width", size/2)
										.attr("height", size/1.5)
										.attr("fill", b === 0 ? "#333" : b === 1 ? "#999" : "#ddd")
										.attr("stroke", "#333")
										.attr("stroke-width", 2.5)

									me.append("rect")
										.attr("x", loc.x)
										.attr("y", loc.y - 2)
										.attr("width", size)
										.attr("height", 3)
										.attr("fill", "#333")
							});
						});
			}

			function setupDiscreteTimeSingleRow(div) {
				var width = 960;
				var height = 50;
				var maxSteps = 20;

				var svg = div.select("svg")
						.attr("width", width)
						.attr("height", height)
						// .style("border", "1px solid #ddd");

				var size = 20;

				var ca = CA(1,2)
						.numCells(41)
						.rule(mainrule);

				var xscale = d3.scale.ordinal()
						.domain(d3.range(ca.numCells()))
						.rangeRoundBands([0, 0.9*width], 0, 0);

				var cells = svg.append("g").selectAll(".dt-cells").data(ca.currentCellStates())
						.enter().append("svg:image")
							.attr("class", function(d,i){ return "cn-cells cn-cell"+i; })
							.attr("x", function(d,i){ return 0 * width + xscale(i); })
							.attr("y", height/2-size/2)
							.attr("width", size)
							.attr("height", size)
							.attr("xlink:href", function(d,i){ return images[d]; });

				var button = div.select("#discrete-time-single-row-button").on("click", function(){
					var me = d3.select(this);
					if (reset) {
						ca.reset();
						i = 0;
						counterText.text("t = " + i);
						reset = false;
						cells.data(ca.currentCellStates()).attr("xlink:href", function(d,i){ return images[d]; });
						me.classed("running", false).text("Start");
					}
					else {
						me.classed("running", !me.classed("running"));
						if (!me.classed("running")) { me.text("Start"); window.cancelAnimationFrame(raf); }
						else { me.text("Pause"); eTime = 0; prevTime = Date.now(); raf = window.requestAnimationFrame(run); }
					}
				});

				var counterText = div.append("p").text("t = 0")
						.style("position", "absolute")
						.style("right", "60px")
						.style("font-size", "12px")
						.style("top", height/2 + size/2 + 45 + "px");


				

				var curTime = Date.now();
				var prevTime = Date.now();
				var eTime = 0;
				var delay = 1000;
				var i = 0;
				var reset = false;
				var center = { x: width / 2, y: height / 2 };

				var raf;// = window.requestAnimationFrame(run);

				

				function run(t) {		

					curTime = Date.now();	
					eTime += curTime - prevTime;
					prevTime = curTime;
					console.log(eTime);

					if (eTime >= delay) {
						eTime = 0;
						if (i === maxSteps) { 
							button.text("Reset"); 
							window.cancelAnimationFrame(raf);
							reset = true;
							button.classed("running", false);
							return; 
						}
					
						ca.run();
						i++;

						cells.data(ca.currentCellStates()).attr("xlink:href", function(d,i){ return images[d]; });

						counterText.text("t = " + i);
					}
					raf = window.requestAnimationFrame(run);
				}
			}

			function setupExploreSimpleNetwork(svg) {
				var width = 960;
				var height = 500;
				svg.attr("width", width).attr("height", height);

				var ca = CA(1,2)
						.numCells(7)
						.rule(mainrule)
						.randomizeStates();
						// .run();

				var center = { x: width / 2, y: height / 2 };
				var radius = 150;
				var size = 60;
				var angle = 2 * Math.PI / ca.numCells();
				var angleoffset = Math.PI/2;

				var cellLocs = [];
				for (var i=0; i<ca.numCells(); i++) {
					cellLocs[i] = { x: radius * Math.cos(i * angle + angleoffset) + center.x - size/2,
													y: radius * Math.sin(i * angle + angleoffset) + center.y - size/2 };
				}

				for (var i=0; i<ca.numCells(); i++) {
					var x1, x2, y1, y2;

					x1 = cellLocs[i].x + size/2;
					y1 = cellLocs[i].y + size/2;
					x2 = cellLocs[mod(i+1, cellLocs.length)].x + size/2;
					y2 = cellLocs[mod(i+1, cellLocs.length)].y + size/2;

					svg.append("line")
							.attr("class", "sn-line")
							.attr("x1", x1)
							.attr("y1", y1)
							.attr("x2", x2)
							.attr("y2", y2)
							.attr("stroke", "#fff")
							.attr("stroke-width", 3);
				}

				var cellGroup = svg.append("g").selectAll(".cn-cells").data(ca.currentCellStates())
						.enter().append("g");
				cellGroup.each(function(d,i){
					var me = d3.select(this);
					// var numCells = ca.numCells();
					var loc = cellLocs[i];
					
					var c = me.append("svg:image")
							.attr("class", "cn-cells cn-cell"+i)
							.attr("x", loc.x)
							.attr("y", loc.y)
							.attr("width", size)
							.attr("height", size)
							.attr("xlink:href", images[d])
						.on("mouseover", function(){
							// happy face; chatting face
							// text bubble, saying hi to neighbors

							var lines = d3.selectAll(".sn-line");
							lines.attr("stroke", "#fff");
							lines.filter(function(a,b){ return (b === i) || (b === mod(i-1, cellLocs.length)); })
									.attr("stroke", "#ddd");

						});

					// me.select(".face").remove();
					// if (d === 0) drawSleepyFace(me, size, loc);
					// else drawAwakeFace(me, size, loc);

							
				});
			}

			function setupAwakeAsleepIntro(div) {

				var svg = div.select("svg");
				var width = 960;
				var height = 180;
				svg.attr("width", width).attr("height", height);

				var center = { x: width / 2, y: height/2 };
				var size = 80;

				svg.append("line")
						.attr("x1", center.x)
						.attr("y1", height * 0.1)
						.attr("x2", center.x)
						.attr("y2", height * 0.9)
						.attr("stroke", "#aaa");

				var awakeLoc = { x: 3 * center.x / 2 - size/2, y: center.y - size/1.5 };
				svg.append("svg:image")
				   .attr('x', awakeLoc.x)
				   .attr('y', awakeLoc.y)
				   .attr('width', size)
				   .attr('height', size)
				   .attr("xlink:href", images[1])

				svg.append("text")
						.attr("x", awakeLoc.x + size / 2)
						.attr("y", awakeLoc.y + size + 50)
						.attr("text-anchor", "middle")
						.text("awake")
						.attr("font-size", "1.5em")
						.attr("font-family", "Helvetica")
						// .attr("font-weight", "bold")
						.attr("stroke", stateColors[1])
						.attr("stroke-width", 1)
						.attr("fill", stateColors[1]);

				
				// var sleepCell = svg.append("g");
				// sleepCell.append("rect")
				// 		.attr("x", sleepLoc.x)
				// 		.attr("y", sleepLoc.y)
				// 		.attr("rx", size / 10)
				// 		.attr("width", size)
				// 		.attr("height", size)
				// 		.attr("stroke", stateColors[0])
				// 		.attr("stroke-width", size / 10)
				// 		.attr("fill", Color(stateColors[0]).a(0.5).rgbaString());

				// sleepCell.select(".face").remove();
				// drawSleepyFace(sleepCell, size, sleepLoc);
				

				var sleepLoc = { x: center.x / 2 - size/2, y: center.y - size/1.5 };
				svg.append("svg:image")
				   .attr('x', sleepLoc.x)
				   .attr('y', sleepLoc.y)
				   .attr('width', size)
				   .attr('height', size)
				   .attr("xlink:href", images[0])

				svg.append("text")
						.attr("x", sleepLoc.x + size / 2)
						.attr("y", sleepLoc.y + size + 50)
						.attr("text-anchor", "middle")
						.text("asleep")
						.attr("font-size", "1.5em")
						.attr("font-family", "Helvetica")
						// .attr("font-weight", "bold")
						.attr("stroke", stateColors[0])
						.attr("stroke-width", 1)
						.attr("fill", stateColors[0]);   

				// var awakeCell = svg.append("g");
				// awakeCell.append("rect")
				// 		.attr("x", awakeLoc.x)
				// 		.attr("y", awakeLoc.y)
				// 		.attr("rx", size / 10)
				// 		.attr("width", size)
				// 		.attr("height", size)
				// 		.attr("stroke", stateColors[1])
				// 		.attr("stroke-width", size / 10)
				// 		.attr("fill", Color(stateColors[1]).a(0.5).rgbaString());
						
				// awakeCell.select(".face").remove();
				// drawAwakeFace(awakeCell, size, awakeLoc);
			}

			function setupCircularNetwork(svg) {

				var ca = CA(1,2)
						.numCells(41)
						.rule(mainrule);

				var curTime = Date.now();
				var prevTime = Date.now();
				var eTime = 0;
				var delay = 1000;
				var i = 0;
				var reset = false;
				var center = { x: window.innerWidth * 0.6 / 2, y: 350 };
				var radius = 310;
				var size = 33;
				var angle = 2 * Math.PI / ca.numCells();
				var angleoffset = Math.PI/1.91;

				var runAndRules = svg.append("g");
				var runRect = runAndRules.append("rect")
						.attr({ x: center.x - 60, y: center.y - 30, rx: 10, width: 100, height: 40, fill: "#333333" })
						.on("click", function(){
							if (reset) {
								ca.reset();
								i = 0;
								counterText.text("t = 0");
								runtext.text("Run");
								reset = false;
								cells.data(ca.currentCellStates()).attr("xlink:href", function(d,i){ return images[d]; });
							}
							else {
								d3.select(this).classed("running", !d3.select(this).classed("running"));
								if (!d3.select(this).classed("running")) { runtext.text("Run"); window.cancelAnimationFrame(raf); }
								else { runtext.text("Stop"); eTime = 0; prevTime = Date.now(); raf = window.requestAnimationFrame(run); }
							}
						});
				var runtext = runAndRules.append("text").attr({ "text-anchor": "middle", x: window.innerWidth * 0.6/2-10, y: 347, fill: "#ffffff" }).text("Run").style("pointer-events", "none");

				var counterText = runAndRules.append("text").attr({ "font-weight": "bold", "text-anchor": "middle", x: window.innerWidth * 0.6/2-10, y: 245, fill: "#333" }).text("t = " + i).style("pointer-events", "none");

				var raf;// = window.requestAnimationFrame(run);

				

				function run(t) {		

					curTime = Date.now();	
					eTime += curTime - prevTime;
					prevTime = curTime;
					console.log(eTime);

					if (eTime >= delay) {
						eTime = 0;
						if (i === 20) { 
							runtext.text("Reset"); 
							window.cancelAnimationFrame(raf);
							reset = true;
							runRect.classed("running", false);
							return; 
						}
					
						ca.run();
						i++;

						cells.data(ca.currentCellStates()).attr("xlink:href", function(d,i){ return images[d]; });

						counterText.text("t = " + i);
					}
					raf = window.requestAnimationFrame(run);
				}

				// init cell groups
				var cells = svg.append("g").selectAll(".cn-cells").data(ca.currentCellStates())
						.enter().append("svg:image")
							.attr("class", "cn-cells")
							.attr("x", function(d,i){ return radius * Math.cos(i * angle + angleoffset) + center.x - size/2; })
							.attr("y", function(d,i){ return radius * Math.sin(i * angle + angleoffset) + center.y - size/2; })
							.attr("width", size)
							.attr("height", size)
							.attr("xlink:href", function(d,i){ return images[d]; });
			}

			function setupStateTimeGrid(div) {

				// var button = div.append("button").text("Play").on("click", function(){
				// 	var me = d3.select(this);
				// 	if (reset) {
				// 		ca.reset();
				// 		t = 0;
				// 		reset = false;

				// 		timeGroups.each(function(a,b){
				// 			me.selectAll(".st-cells")
				// 				.attr("xlink:href", function(d,i){ return b === t ? images[d] : ghostImages[d]; })
				// 				.attr("opacity", b <= t ? 1 : 0);
				// 		});
				// 	}
				// 	else {
				// 		me.classed("running", !me.classed("running"));
				// 		if (!me.classed("running")) { me.text("Run"); window.cancelAnimationFrame(raf); }
				// 		else { me.text("Stop"); eTime = 0; prevTime = Date.now(); raf = window.requestAnimationFrame(run); }
				// 	}
				// })

				var svg = div.select("svg");

				var ghostImages = [ "img/asleep-cell-square-ghost.svg", "img/awake-cell-square-ghost.svg" ];
				var width = 960;
				var height = 440;
				svg.attr("width", width).attr("height", height)

				var runs = 87;
				var rule = mainrule;
				var numCells = 192;
				var ca = CA(1,2)
						.numCells(numCells)
						.rule(rule)
						.run(runs);

				var size = 5;
				var padding = size * 0.0;
				var start = 0;

				var timeGroups = svg.append("g").selectAll(".time-groups").data(ca.cellStatesStr())
					.enter().append("g");
				
				// init time and cell groups
				timeGroups.each(function(d,i){
					var me = d3.select(this);
					// console.log(d)
					me.selectAll(".cell-groups").data(d)
						// .enter().append("svg:image")
						.enter().append("rect")
							.attr("class", "st-cells")
							.attr("x", function(a,b){ return b * (size + padding) + start; })
							.attr("y", function(a,b){ return 0 + i * (size + padding); })
							.attr("rx", 0.5)
							.attr("width", size)
							.attr("height", size)
							// .attr("xlink:href", function(a,b){ return ghostImages[a]; })
							.attr("fill", function(a,b){ return fillColors[a]; })
							.attr("stroke", function(a,b){ return stateColors[a]; })
							.attr("stroke-width", 0.3)
							// .attr("opacity", t === i ? 1 : 0);
				})
			}

			function setupStateTimeGridAnim(div) {

				var svg = div.select("svg");

				var ghostImages = [ "img/asleep-cell-square-ghost.svg", "img/awake-cell-square-ghost.svg" ];
				var width = 960;
				var height = 480;
				svg.attr("width", width).attr("height", height)//.style("border", "1px solid #ddd")

				var button = div.select("#state-time-grid-anim-button").on("click", function(){
					var me = d3.select(this);
					if (reset) {
						ca.reset();
						t = 0;
						reset = false;
						me.text("Start");
						timeGroups.each(function(a,b){
							d3.select(this).selectAll(".st-cells")
								.attr("xlink:href", function(d,i){ return b === t ? images[d] : ghostImages[d]; })
								.attr("opacity", b <= t ? 1 : 0);
						});
						counterText.style("opacity", function(d,i){ return i <= t ? 1 : 0; });

					}
					else {
						me.classed("running", !me.classed("running"));
						if (!me.classed("running")) { me.text("Start"); window.cancelAnimationFrame(raf); }
						else { me.text("Pause"); eTime = 0; prevTime = Date.now(); raf = window.requestAnimationFrame(run); }
					}
				})

				var runs = 20;
				var rule = mainrule;
				var numCells = 41;
				var ca = CA(1,2)
						.numCells(numCells)
						.rule(rule)
						.run(runs);

				var size = 20;
				var t = 0;

				var xscale = d3.scale.ordinal()
						.domain(d3.range(ca.numCells()))
						.rangeRoundBands([0, 0.9 * width], 0, 0);


				var timeGroups = svg.append("g").selectAll(".time-groups").data(ca.cellStatesStr())
					.enter().append("g");
				
				// init time and cell groups
				timeGroups.each(function(d,i){
					var me = d3.select(this);
					// console.log(d)
					me.selectAll(".cell-groups").data(d)
						.enter().append("svg:image")
							.attr("class", "st-cells")
							.attr("x", function(a,b){ return 0 * width + xscale(b); })
							.attr("y", function(a,b){ return 30 + i * size; })
							.attr("width", size)
							.attr("height", size)
							.attr("xlink:href", function(a,b){ return images[a]; })
							.attr("opacity", t === i ? 1 : 0);
				});


				var counterText = div.selectAll(".time-counter-text").data(ca.cellStatesStr())
					.enter().append("p")
						.text(function(d,i){ return "t = " + i; })
						.style("position", "absolute")
						.style("right", "60px")
						.style("font-size", "12px")
						.style("top", function(d,i){ return 92 + (i * size) + 4 + "px"; })
						.style("opacity", function(d,i){ return i <= t ? 1 : 0; });

				
				

				var curTime = Date.now();
				var prevTime = Date.now();
				var eTime = 0;
				var delay = 1000;
				var t = 0;
				var reset = false;
				var allcellstates = ca.cellStatesStr();

				
				var raf;// = window.requestAnimationFrame(run);

				function run() {		

					curTime = Date.now();	
					eTime += curTime - prevTime;
					prevTime = curTime;
					// console.log(eTime);

					if (eTime >= delay) {
						eTime = 0;
						if (t === runs) { 
							button.text("Reset"); 
							window.cancelAnimationFrame(raf);
							reset = true;
							button.classed("running", false);
							return; 
						}
					
						ca.run();
						t++;
						timeGroups.each(function(a,b){
							// console.log(t);
							// console.log(b);
							d3.select(this).selectAll(".st-cells")
									.attr("xlink:href", function(d,i){ return b === t ? images[d] : ghostImages[d]; })
									.attr("opacity", b <= t ? 1 : 0);
						});

						counterText.style("opacity", function(d,i){ return i <= t ? 1 : 0; });
						
					}
					raf = window.requestAnimationFrame(run);
				}
			}

			function setupSocialSituations(div) {

				var width = 960;
				var height = 280;
				var svg = div.select("svg");
				svg.attr("width", width).attr("height", height);
				// svg.style("border", "1px solid black")

				var configs = [ [1,1,1],
												[1,1,0],
												[1,0,1],
												[1,0,0],
												[0,1,1],
												[0,1,0],
												[0,0,1],
												[0,0,0] ];


				var ca = CA(1,2);
				var size = 30;
				var decRule = mainrule;
				var arrRule = ca.rule(decRule).ruleComponents();

				var socsits = svg.selectAll(".ss-cell-groups").data(configs)
					.enter().append("g")
						.attr("class", "ss-cell-groups");

				socsits.each(function(d,i){
					var me = d3.select(this);
					me.append("g").selectAll(".ss-cell").data(d)
						.enter().append("svg:image")
							.attr("x", function(a,b){ return 15 + (i * 120) + (size * b); })
							.attr("y", 0)
							.attr('width', size)
							.attr('height', size)
							.attr("xlink:href", function(a,b){ return images[a]; });
				})

				var binarytext = svg.selectAll(".s-plus-1-binary-text").data(arrRule)
					.enter().append("text")
						.attr("x", function(a,b){ return 15 + (b * 120) + size + size/2; })
						.attr("y", 60)
				    .attr("font-size", "0em")
				    .attr("text-anchor", "middle")
				    .attr("font-weight", "bold")
				    .text(function(a,b){ return a; })
				    .classed("sleeping", function(a,b){ return a === 0 ? true : false; });

				var binarylines = svg.selectAll(".s-lines").data(arrRule)
					.enter().append("line")
						.attr("x1", function(a,b){ return 15 + (b * 120) + size + size/2; })
						.attr("y1", 65)
						.attr("x2", function(a,b){ return 15 + (b * 120) + size + size/2; })
						.attr("y2", 115)
						.attr("stroke", function(a,b){ return fillColors[a]; });

				var twosExpRects = svg.selectAll(".twos-exp-rect").data(arrRule)
					.enter().append("rect")
						.attr("x", function(a,b){ return 15 + (b * 120) + size * 1.15; })
						.attr("y", 115)
						.attr("width", size * 0.7)
						.attr("height", 20)
				    .attr("stroke", function(a,b){ return fillColors[a]; })
				    .attr("fill", "transparent")
				    .style("cursor", "pointer")
				    .text(function(a,b){ return "2^" + (arrRule.length-1-b); })
				  .on("click", function(d,i){
				  	var me = ruleCells.filter(function(a,b){ return b === i; });

				  	me.classed("sleeping", !me.classed("sleeping"));

				  	if (me.classed("sleeping")) me.attr("xlink:href", images[0]);
				  	else me.attr("xlink:href", images[1]);

				  	var bt = binarytext.filter(function(k,j){ return j === i; });
				  	bt.classed("sleeping", !bt.classed("sleeping"));

				  	if (bt.classed("sleeping")) {
				  		bt.text("0");
				  	} 
				  	else {
				  		bt.text("1");
				  	}

				  	binarytext.each(function(k,j){
				  		var sleeping = d3.select(this).classed("sleeping");
				  		arrRule[j] = sleeping ? 0 : 1;
				  	})

				  	binarylines.data(arrRule).attr("stroke", function(a,b){ return fillColors[a]; });
				  	binarylines2.data(arrRule).attr("stroke", function(a,b){ return a === 0 ? "transparent" : fillColors[1]; });
				  	twosExpRects.data(arrRule).attr("stroke", function(a,b){ return fillColors[a]; });
				  	twosExp.data(arrRule).attr("fill", function(a,b){ return fillColors[a]; });
				  	hlines.data(arrRule).attr("stroke", function(a,b){ return a === 0 ? "transparent" : fillColors[1]; })


				  	decRule = basek2dec(arrRule, 2);
				  	ruletext.text("Rule: " + decRule);
				  });


				var twosExp = svg.selectAll(".twos-exp").data(arrRule)
					.enter().append("text")
						.attr("x", function(a,b){ return 15 + (b * 120) + size + size/2; })
						.attr("y", 130)
				    .attr("font-size", "10px")
				    .attr("text-anchor", "middle")
				    .attr("fill", function(a,b){ return fillColors[a]; })
				    .style("pointer-events", "none")
				    .text(function(a,b){ return "2^" + (arrRule.length-1-b); }); 
 

				var binarylines2 = svg.selectAll(".s-lines2").data(arrRule)
					.enter().append("line")
						.attr("x1", function(a,b){ return 15 + (b * 120) + size + size/2; })
						.attr("y1", 135)
						.attr("x2", function(a,b){ return 15 + (b * 120) + size + size/2; })
						.attr("y2", 195)
						.attr("stroke", function(a,b){ return a === 0 ? "transparent" : fillColors[1]; });

				var hlines = svg.selectAll(".connection-lines").data(arrRule)
					.enter().append("line")
						.attr("x1", function(a,b){ return 15 + (b * 120) + size + size/2; })
						.attr("y1", 195)
						.attr("x2", 15 + size + size/2 + (7 * 120)/2)
						.attr("y2", 195)
						.attr("stroke", function(a,b){ return a === 0 ? "transparent" : fillColors[1]; });

				var vline = svg.append("line")
						.attr("x1", 15 + size + size/2 + (7 * 60))
						.attr("y1", 195)
						.attr("x2", 15 + size + size/2 + (7 * 60))
						.attr("y2", 230)
						.attr("stroke", fillColors[1]);		

				var ruletext = svg.append("text")
						.attr("x", 15 + size + size/2 + (7 * 60))
						.attr("y", 260)
						.attr("font-size", "20px")
						.attr("text-anchor", "middle")
						.attr("font-weight", "bold")
						.style("pointer-events", "none")
						.text("Rule: " + decRule)				



				var ruleCells = svg.selectAll(".s-plus-1-cell").data(arrRule)
					.enter().append("svg:image")
						.attr("x", function(a,b){ return 15 + (b * 120) + size; })
						.attr("y", 40)
				    .attr('width', size)
				    .attr('height', size)
				    .attr("xlink:href", function(a,b){ return images[a]; })
				    .classed("sleeping", function(a,b){ return a === 0 ? true : false; })
				    .style("cursor", "pointer")
				  .on("click", function(a,b){
				  	var me = d3.select(this);
				  	me.classed("sleeping", !me.classed("sleeping"));

				  	if (me.classed("sleeping")) me.attr("xlink:href", images[0]);
				  	else me.attr("xlink:href", images[1]);

				  	var bt = binarytext.filter(function(k,j){ return j === b; });
				  	bt.classed("sleeping", !bt.classed("sleeping"));

				  	if (bt.classed("sleeping")) {
				  		bt.text("0");
				  	} 
				  	else {
				  		bt.text("1");
				  	}

				  	binarytext.each(function(k,j){
				  		var sleeping = d3.select(this).classed("sleeping");
				  		arrRule[j] = sleeping ? 0 : 1;
				  	})

				  	binarylines.data(arrRule).attr("stroke", function(a,b){ return fillColors[a]; });
				  	binarylines2.data(arrRule).attr("stroke", function(a,b){ return a === 0 ? "transparent" : fillColors[1]; });
				  	twosExpRects.data(arrRule).attr("stroke", function(a,b){ return fillColors[a]; });
				  	twosExp.data(arrRule).attr("fill", function(a,b){ return fillColors[a]; });
				  	hlines.data(arrRule).attr("stroke", function(a,b){ return a === 0 ? "transparent" : fillColors[1]; })


				  	// console.log(arrRule.reverse());
				  	decRule = basek2dec(arrRule, 2);
				  	ruletext.text("Rule: " + decRule);
				  })
			}


			
			
</script>	
</body>
</html>
